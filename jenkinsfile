pipeline {
    agent any
    
    environment { 
        def ITEMNAME = "${JOB_NAME}"
        def DESTPATH = "/app/webroot"
        def codePATH = "/app/jenkins/workspace/${JOB_NAME}"
    }
    
    stages {    
        stage('拉取代码'){
            steps {
                echo "checkout from ${ITEMNAME}"
                git url: ' git@github.com:yangsirs/demo.git', branch: 'master'
            }
        }
        
        stage('目录检查') {
            steps {
                echo "检查${DESTPATH}目录是否存在"
                script{
                    def resultUpdateshell = sh script: 'ls ${DESTPATH}'
                    if (resultUpdateshell == 0) {
                        skip = '0'
                        return
                    }   
                }
            }
        }

        stage('发布确认') {
            steps {
                input "检查完成，是否发布?"
            }
        }    
        
        stage('推送代码') {
            steps {
                echo "code sync"
                sh '''
                    rsync -avz --exclude=.git --exclude=jenkinsfile --delete ${codePATH}  ${DESTPATH}
                    chown -R  nginx  ${DESTPATH}/${JOB_NAME}
                '''
            }
        }
    }
    
    post {
        success {
            echo 'I succeeeded!'
        }
        failure {
            mail to: 'yangjingwen@pxjy.com',
            subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
            body: "Something is wrong with ${env.BUILD_URL}"
        }
    }
}
